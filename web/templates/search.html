{% extends "base.html" %}

{% block title %}Search - Datalake{% endblock %}

{% block content %}
<style>
    .search-form {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .search-form input[type="text"] {
        flex: 1;
        min-width: 300px;
        padding: 0.75rem 1rem;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #c9d1d9;
        font-size: 1rem;
    }
    .search-form select {
        padding: 0.75rem 1rem;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #c9d1d9;
    }
    .search-form button {
        padding: 0.75rem 1.5rem;
        background: #238636;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-weight: 600;
    }
    .search-form button:hover { background: #2ea043; }
    .results-section {
        margin-bottom: 2rem;
    }
    .results-section h2 {
        border-bottom: 1px solid #30363d;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    .result-card {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }
    .result-card:hover { border-color: #58a6ff; }
    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    .result-meta {
        font-size: 0.85rem;
        color: #8b949e;
    }
    .result-content {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 150px;
        overflow-y: auto;
        font-size: 0.9rem;
    }
    .highlight {
        background: #f0883e40;
        padding: 0 0.2rem;
        border-radius: 2px;
    }
    .no-results {
        text-align: center;
        padding: 3rem;
        color: #8b949e;
    }
    .search-tips {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .search-tips h3 { margin-bottom: 0.5rem; }
    .search-tips code {
        background: #0d1117;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .count-badge {
        background: #21262d;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-left: 0.5rem;
    }
</style>

<h1>Search</h1>

<form class="search-form" method="GET" action="/search">
    <input type="text" name="q" value="{{ query }}" placeholder="Search conversations, history, transcripts..." autofocus>
    <select name="type">
        <option value="all" {% if request.args.get('type', 'all') == 'all' %}selected{% endif %}>All</option>
        <option value="messages" {% if request.args.get('type') == 'messages' %}selected{% endif %}>Messages</option>
        <option value="history" {% if request.args.get('type') == 'history' %}selected{% endif %}>History</option>
        <option value="transcripts" {% if request.args.get('type') == 'transcripts' %}selected{% endif %}>Transcripts</option>
    </select>
    <button type="submit">Search</button>
</form>

{% if not query %}
<div class="search-tips">
    <h3>Search Tips</h3>
    <p>This search uses SQLite FTS5 (Full-Text Search). Examples:</p>
    <ul style="margin-top: 0.5rem; margin-left: 1.5rem; color: #8b949e;">
        <li><code>python flask</code> - Find documents containing both words</li>
        <li><code>"exact phrase"</code> - Find an exact phrase</li>
        <li><code>flask OR django</code> - Find documents with either word</li>
        <li><code>python -testing</code> - Find python but not testing</li>
        <li><code>func*</code> - Wildcard: function, functional, etc.</li>
    </ul>
</div>
{% endif %}

{% if results %}
    {% if results.messages %}
    <div class="results-section">
        <h2>Messages <span class="count-badge">{{ results.messages|length }}</span></h2>
        {% for r in results.messages %}
        <div class="result-card">
            <div class="result-header">
                <div>
                    <span class="badge badge-{{ r.message_type }}">{{ r.message_type }}</span>
                    <a href="/session/{{ r.session_id }}">{{ r.summary or r.session_id[:8] + '...' }}</a>
                </div>
                <span class="result-meta">{{ r.timestamp[:16] if r.timestamp else '' }}</span>
            </div>
            <div class="result-content">{{ r.content_text[:500] }}{% if r.content_text|length > 500 %}...{% endif %}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if results.history %}
    <div class="results-section">
        <h2>History <span class="count-badge">{{ results.history|length }}</span></h2>
        {% for r in results.history %}
        <div class="result-card">
            <div class="result-header">
                <div>
                    {% if r.session_id %}
                    <a href="/session/{{ r.session_id }}">View Session</a>
                    {% else %}
                    <span class="result-meta">(no linked session)</span>
                    {% endif %}
                </div>
                <span class="result-meta">{{ r.timestamp[:16] if r.timestamp else '' }}</span>
            </div>
            <div class="result-content">{{ r.display }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if results.transcripts %}
    <div class="results-section">
        <h2>Voice Transcripts <span class="count-badge">{{ results.transcripts|length }}</span></h2>
        {% for r in results.transcripts %}
        <div class="result-card">
            <div class="result-header">
                <div>
                    <span class="result-meta">{{ r.filename }}</span>
                    {% if r.word_count %}
                    <span class="result-meta">({{ r.word_count }} words)</span>
                    {% endif %}
                </div>
                <span class="result-meta">{{ r.created_at[:16] if r.created_at else '' }}</span>
            </div>
            <div class="result-content">{{ r.content[:500] }}{% if r.content|length > 500 %}...{% endif %}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if not results.messages and not results.history and not results.transcripts %}
    <div class="no-results">
        <h2>No results found</h2>
        <p>Try adjusting your search terms or using different keywords.</p>
    </div>
    {% endif %}
{% endif %}
{% endblock %}
